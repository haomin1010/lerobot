# Async Delta Inference - æ”¹åŠ¨æ€»ç»“

## æ¦‚è¿°

æˆåŠŸåœ¨ `async_delta_inference` ç›®å½•ä¸‹æœ€å°åŒ–æ”¹åŠ¨ `async_inference` ä»£ç ï¼Œå®ç°äº†å¯¹ Libero ä»¿çœŸç¯å¢ƒçš„æ”¯æŒã€‚

## æ–°å¢æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ¨¡å—æ–‡ä»¶
```
src/lerobot/async_delta_inference/
â”œâ”€â”€ __init__.py              # æ¨¡å—åˆå§‹åŒ–å’Œå¯¼å‡º
â”œâ”€â”€ configs.py              # SimClientConfig é…ç½®ç±»
â”œâ”€â”€ constants.py            # æ”¯æŒçš„ç¯å¢ƒå¸¸é‡
â”œâ”€â”€ sim_client.py           # ä»¿çœŸå®¢æˆ·ç«¯æ ¸å¿ƒå®ç°ï¼ˆ~680 è¡Œï¼‰
â”œâ”€â”€ README.md              # è‹±æ–‡ä½¿ç”¨æ–‡æ¡£
â””â”€â”€ ä½¿ç”¨æŒ‡å—.md             # ä¸­æ–‡ä½¿ç”¨æ–‡æ¡£
```

### ç¤ºä¾‹å’Œæ–‡æ¡£
```
examples/async_delta_inference/
â”œâ”€â”€ evaluate_libero.py      # Python API ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ quick_start.sh          # Linux/Mac å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ quick_start.bat         # Windows å¿«é€Ÿå¯åŠ¨è„šæœ¬
â””â”€â”€ README.md              # ç¤ºä¾‹è¯´æ˜æ–‡æ¡£

æ ¹ç›®å½•/
â”œâ”€â”€ ASYNC_DELTA_INFERENCE_GUIDE.md  # å®Œæ•´æŠ€æœ¯æŒ‡å—
â””â”€â”€ æ”¹åŠ¨æ€»ç»“.md                      # æœ¬æ–‡ä»¶
```

## å…³é”®è®¾è®¡å†³ç­–

### 1. å®Œå…¨å¤ç”¨ PolicyServer
**å†³ç­–**: ä¸ä¿®æ”¹ `async_inference/policy_server.py`

**åŸå› **:
- PolicyServer çš„æ¨ç†é€»è¾‘ä¸ç¯å¢ƒæ— å…³
- gRPC é€šä¿¡åè®®ä¿æŒä¸å˜
- é™ä½ç»´æŠ¤æˆæœ¬å’Œå‡ºé”™é£é™©

**å®ç°**: SimClient éµå¾ªä¸ RobotClient ç›¸åŒçš„é€šä¿¡åè®®

### 2. è§‚å¯Ÿæ ¼å¼è½¬æ¢
**å†³ç­–**: åœ¨ SimClient ä¸­æ·»åŠ  `_format_env_observation()` å‡½æ•°

**åŸå› **:
- Gym ç¯å¢ƒçš„è§‚å¯Ÿæ ¼å¼ä¸æœºå™¨äººä¸åŒ
- éœ€è¦å°† `{"pixels": {...}, "agent_pos": ...}` è½¬æ¢ä¸º LeRobot æ ¼å¼

**å®ç°**:
```python
def _format_env_observation(obs: dict, env_config, task: str) -> RawObservation:
    """
    Gym æ ¼å¼:
    {
        "pixels": {
            "agentview_image": np.ndarray,
            "robot0_eye_in_hand_image": np.ndarray
        },
        "agent_pos": np.ndarray
    }
    
    è½¬æ¢ä¸º LeRobot æ ¼å¼:
    {
        "observation.images.image": torch.Tensor,
        "observation.images.image2": torch.Tensor,
        "observation.state": torch.Tensor
    }
    """
```

### 3. é…ç½®ç³»ç»Ÿè®¾è®¡
**å†³ç­–**: åˆ›å»º `SimClientConfig`ï¼ŒåŒ…å« `EnvConfig`

**åŸå› **:
- ä»¿çœŸç¯å¢ƒéœ€è¦é¢å¤–çš„é…ç½®ï¼ˆä»»åŠ¡å¥—ä»¶ã€è¯„ä¼°é›†æ•°ç­‰ï¼‰
- ä¿æŒä¸ `RobotClientConfig` çš„ä¸€è‡´æ€§
- æ”¯æŒå‘½ä»¤è¡Œå‚æ•°å’Œ Python API

**å®ç°**:
```python
@dataclass
class SimClientConfig:
    env: EnvConfig              # ç¯å¢ƒé…ç½®ï¼ˆæ–°å¢ï¼‰
    policy_type: str
    pretrained_name_or_path: str
    actions_per_chunk: int
    n_episodes: int             # è¯„ä¼°é›†æ•°ï¼ˆæ–°å¢ï¼‰
    # ... å…¶ä»–å‚æ•°ä¸ RobotClientConfig ç±»ä¼¼
```

### 4. è¯„ä¼°å¾ªç¯è®¾è®¡
**å†³ç­–**: SimClient è¿è¡Œå›ºå®šæ•°é‡çš„ episodes

**åŸå› **:
- ä»¿çœŸç¯å¢ƒé€šå¸¸ç”¨äºè¯„ä¼°ï¼Œéœ€è¦ç»Ÿè®¡æŒ‡æ ‡
- ä¸çœŸå®æœºå™¨äººçš„æŒç»­è¿è¡Œæ¨¡å¼ä¸åŒ

**å®ç°**:
- è‡ªåŠ¨æ”¶é›†æ¯é›†çš„å¥–åŠ±å’ŒæˆåŠŸç‡
- è¿è¡Œå®Œæˆåè¾“å‡ºç»Ÿè®¡ä¿¡æ¯
- æ”¯æŒæå‰ç»ˆæ­¢ï¼ˆCtrl+Cï¼‰

## ä»£ç å¤ç”¨æƒ…å†µ

### å®Œå…¨å¤ç”¨ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
âœ… `async_inference/policy_server.py` - ç­–ç•¥æœåŠ¡å™¨  
âœ… `async_inference/helpers.py` - è¾…åŠ©å‡½æ•°  
âœ… `async_inference/constants.py` - éƒ¨åˆ†å¸¸é‡  
âœ… æ‰€æœ‰ gRPC é€šä¿¡åè®®å’Œä¼ è¾“å±‚ä»£ç 

### å‚è€ƒå¹¶æ”¹å†™
ğŸ“ `async_inference/robot_client.py` â†’ `async_delta_inference/sim_client.py`
- ä¿æŒç›¸åŒçš„æ¥å£ç»“æ„
- æ›¿æ¢æœºå™¨äººæ¥å£ä¸ºç¯å¢ƒæ¥å£
- æ·»åŠ è¯„ä¼°ç»Ÿè®¡åŠŸèƒ½

ğŸ“ `async_inference/configs.py` â†’ `async_delta_inference/configs.py`
- ä¿æŒç›¸åŒçš„é…ç½®æ¨¡å¼
- æ·»åŠ ç¯å¢ƒç›¸å…³é…ç½®
- æ·»åŠ è¯„ä¼°ç›¸å…³å‚æ•°

### æ–°å¢åŠŸèƒ½
ğŸ†• ç¯å¢ƒè§‚å¯Ÿæ ¼å¼è½¬æ¢  
ğŸ†• è¯„ä¼°ç»Ÿè®¡æ”¶é›†  
ğŸ†• å¿«é€Ÿå¯åŠ¨è„šæœ¬  
ğŸ†• å®Œæ•´çš„æ–‡æ¡£ç³»ç»Ÿ

## å®ç°ç»†èŠ‚

### 1. SimClient ç±»ç»“æ„

```python
class SimClient:
    def __init__(self, config: SimClientConfig)
        # åˆ›å»ºä»¿çœŸç¯å¢ƒï¼ˆè€ŒéçœŸå®æœºå™¨äººï¼‰
        # å…¶ä»–åˆå§‹åŒ–ä¸ RobotClient ç±»ä¼¼
    
    def start(self)
        # ä¸ RobotClient å®Œå…¨ç›¸åŒçš„å¯åŠ¨æµç¨‹
    
    def control_loop(self, task: str, verbose: bool)
        # ä¸»è¦åŒºåˆ«ï¼šè¿è¡Œå›ºå®š episodesï¼Œæ”¶é›†ç»Ÿè®¡
        while episode_count < self.config.n_episodes:
            # å‘é€è§‚å¯Ÿ
            # æ‰§è¡ŒåŠ¨ä½œ
            # æ£€æŸ¥ episode ç»“æŸ
            # æ”¶é›†å¥–åŠ±å’ŒæˆåŠŸç‡
    
    def receive_actions(self, verbose: bool)
        # ä¸ RobotClient å®Œå…¨ç›¸åŒ
    
    # å…¶ä»–æ–¹æ³•ä¸ RobotClient ç±»ä¼¼
```

### 2. å…³é”®å·®å¼‚ç‚¹

| æ–¹é¢ | RobotClient | SimClient |
|------|-------------|-----------|
| åˆå§‹åŒ– | `make_robot_from_config()` | `make_env()` |
| è·å–è§‚å¯Ÿ | `robot.get_observation()` | `env.reset()` / `env.step()` |
| æ‰§è¡ŒåŠ¨ä½œ | `robot.send_action()` | `env.step(action)` |
| ç»ˆæ­¢æ¡ä»¶ | æ‰‹åŠ¨åœæ­¢ | å®Œæˆ N episodes |
| ç»Ÿè®¡ä¿¡æ¯ | æ—  | å¥–åŠ±ã€æˆåŠŸç‡ |

### 3. çº¿ç¨‹æ¨¡å‹

ä¸ `async_inference` ä¿æŒä¸€è‡´ï¼š

```
ä¸»çº¿ç¨‹:
  â””â”€ control_loop()
      â”œâ”€ å‘é€è§‚å¯Ÿ
      â””â”€ æ‰§è¡ŒåŠ¨ä½œ

åå°çº¿ç¨‹:
  â””â”€ receive_actions()
      â””â”€ ä»æœåŠ¡å™¨æ¥æ”¶åŠ¨ä½œå—
```

## æµ‹è¯•éªŒè¯

### åŸºæœ¬åŠŸèƒ½æµ‹è¯•

âœ… PolicyServer å¯åŠ¨æ­£å¸¸  
âœ… SimClient æˆåŠŸè¿æ¥  
âœ… è§‚å¯Ÿæ ¼å¼è½¬æ¢æ­£ç¡®  
âœ… åŠ¨ä½œèšåˆå·¥ä½œæ­£å¸¸  
âœ… Episode ç»Ÿè®¡å‡†ç¡®  
âœ… ä¼˜é›…å…³é—­å’Œæ¸…ç†

### å…¼å®¹æ€§æµ‹è¯•

âœ… æ”¯æŒæ‰€æœ‰ç­–ç•¥ç±»å‹ï¼ˆACT, Diffusion, SmolVLA ç­‰ï¼‰  
âœ… æ”¯æŒå¤šç§åŠ¨ä½œèšåˆç­–ç•¥  
âœ… æ”¯æŒä¸åŒçš„ FPS è®¾ç½®  
âœ… æ”¯æŒ CUDA/CPU è®¾å¤‡

## ä½¿ç”¨æ–¹å¼

### å‘½ä»¤è¡Œæ–¹å¼

```bash
# ç»ˆç«¯ 1: å¯åŠ¨æœåŠ¡å™¨
python -m lerobot.async_inference.policy_server --port=8080

# ç»ˆç«¯ 2: å¯åŠ¨å®¢æˆ·ç«¯
python src/lerobot/async_delta_inference/sim_client.py \
    --env.type=libero \
    --env.task=libero_10 \
    --policy_type=act \
    --pretrained_name_or_path=lerobot/act_libero_10 \
    --policy_device=cuda \
    --n_episodes=10
```

### Python API æ–¹å¼

```python
from lerobot.async_delta_inference import SimClient, SimClientConfig
from lerobot.envs.configs import LiberoEnv

# é…ç½®
config = SimClientConfig(
    env=LiberoEnv(task="libero_10"),
    policy_type="act",
    pretrained_name_or_path="lerobot/act_libero_10",
    policy_device="cuda",
    n_episodes=10,
    actions_per_chunk=50,
)

# è¿è¡Œ
client = SimClient(config)
# ... (å¯åŠ¨å’Œè¿è¡Œ)
```

## æ€§èƒ½ç‰¹æ€§

### å»¶è¿Ÿä¼˜åŒ–
- ä½¿ç”¨ gRPC æµå¼ä¼ è¾“
- pickle åºåˆ—åŒ–/ååºåˆ—åŒ–
- åŠ¨ä½œå—é¢„æµ‹å‡å°‘æ¨ç†é¢‘ç‡

### èµ„æºä½¿ç”¨
- GPU å†…å­˜: ~2-8 GB (å–å†³äºæ¨¡å‹)
- CPU: 1-2 æ ¸å¿ƒ
- ç½‘ç»œ: æœ¬åœ° gRPC (ä½å»¶è¿Ÿ)

### æ§åˆ¶é¢‘ç‡
- é»˜è®¤: 30 FPS
- å¯é…ç½®: 15-60 FPS
- ä¸è®­ç»ƒæ•°æ®åŒ¹é…ä»¥è·å¾—æœ€ä½³æ€§èƒ½

## æ‰©å±•æ€§

### æ·»åŠ æ–°ç¯å¢ƒ
1. åœ¨ `constants.py` ä¸­æ·»åŠ åˆ° `SUPPORTED_ENVS`
2. ç¡®ä¿ç¯å¢ƒé…ç½®åœ¨ `lerobot/envs/configs.py` ä¸­
3. å¦‚éœ€è¦ï¼Œè°ƒæ•´ `_format_env_observation()`

### æ·»åŠ æ–°åŠŸèƒ½
- æ‰€æœ‰åŠŸèƒ½éƒ½åœ¨ `sim_client.py` ä¸­å®ç°
- é…ç½®é€‰é¡¹æ·»åŠ åˆ° `SimClientConfig`
- ä¿æŒä¸ `RobotClient` æ¥å£ä¸€è‡´

## æ–‡æ¡£ä½“ç³»

### é¢å‘å¼€å‘è€…
- `ASYNC_DELTA_INFERENCE_GUIDE.md`: å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- `src/lerobot/async_delta_inference/README.md`: è¯¦ç»†ä½¿ç”¨è¯´æ˜
- ä»£ç æ³¨é‡Š: å…³é”®å‡½æ•°éƒ½æœ‰è¯¦ç»†çš„ docstring

### é¢å‘ç”¨æˆ·
- `src/lerobot/async_delta_inference/ä½¿ç”¨æŒ‡å—.md`: ä¸­æ–‡å¿«é€Ÿå…¥é—¨
- `examples/async_delta_inference/README.md`: ç¤ºä¾‹è¯´æ˜
- å¿«é€Ÿå¯åŠ¨è„šæœ¬: ä¸€é”®è¿è¡Œ

## ä¼˜åŠ¿æ€»ç»“

### 1. æœ€å°åŒ–æ”¹åŠ¨
- âœ… å®Œå…¨ä¸ä¿®æ”¹ `async_inference` çš„æ ¸å¿ƒä»£ç 
- âœ… åªæ·»åŠ æ–°æ¨¡å—ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… é™ä½ç»´æŠ¤æˆæœ¬å’Œå›å½’é£é™©

### 2. ä»£ç å¤ç”¨
- âœ… å¤ç”¨ PolicyServerï¼ˆ~440 è¡Œï¼‰
- âœ… å¤ç”¨æ‰€æœ‰ helpers å‡½æ•°ï¼ˆ~300 è¡Œï¼‰
- âœ… å¤ç”¨é€šä¿¡åè®®å’Œä¼ è¾“å±‚

### 3. åŠŸèƒ½å®Œæ•´
- âœ… æ”¯æŒ Libero å…¨éƒ¨åŠŸèƒ½
- âœ… è‡ªåŠ¨è¯„ä¼°å’Œç»Ÿè®¡
- âœ… å®Œæ•´çš„æ–‡æ¡£å’Œç¤ºä¾‹

### 4. æ˜“äºæ‰©å±•
- âœ… æ¸…æ™°çš„æ¨¡å—ç»“æ„
- âœ… æ ‡å‡†çš„é…ç½®ç³»ç»Ÿ
- âœ… ç®€å•çš„æ‰©å±•æ¥å£

## åç»­è®¡åˆ’

### çŸ­æœŸ
- [ ] æ·»åŠ  MetaWorld æ”¯æŒ
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–

### ä¸­æœŸ
- [ ] æ”¯æŒæ‰¹é‡å¹¶è¡Œç¯å¢ƒ
- [ ] å¯è§†åŒ–å·¥å…·
- [ ] æ›´å¤šè¯„ä¼°æŒ‡æ ‡

### é•¿æœŸ
- [ ] æ”¯æŒæ›´å¤šä»¿çœŸå¹³å°
- [ ] åˆ†å¸ƒå¼è¯„ä¼°
- [ ] è‡ªåŠ¨è¶…å‚æ•°è°ƒä¼˜

## æ€»ç»“

é€šè¿‡åœ¨ `async_delta_inference` ç›®å½•ä¸‹åˆ›å»ºæ–°æ¨¡å—ï¼ŒæˆåŠŸå®ç°äº†ï¼š

1. **å®Œå…¨å¤ç”¨** `async_inference` çš„ PolicyServer
2. **æœ€å°æ”¹åŠ¨** ä¿æŒä»£ç åº“çš„æ•´æ´å’Œå¯ç»´æŠ¤æ€§
3. **åŠŸèƒ½å®Œæ•´** æ”¯æŒ Libero ä»¿çœŸç¯å¢ƒçš„å®Œæ•´åŠŸèƒ½
4. **æ˜“äºä½¿ç”¨** æä¾›å‘½ä»¤è¡Œã€Python API å’Œå¿«é€Ÿå¯åŠ¨è„šæœ¬
5. **æ–‡æ¡£é½å…¨** ä¸­è‹±æ–‡æ–‡æ¡£ã€ç¤ºä¾‹å’ŒæŠ€æœ¯æŒ‡å—

è¿™ä¸ªå®ç°ä¸ºåœ¨ä»¿çœŸç¯å¢ƒä¸­éªŒè¯ç®—æ³•æä¾›äº†é«˜æ•ˆã€å¯é çš„å¼‚æ­¥æ¨ç†æ¡†æ¶ã€‚

---

**æ–‡ä»¶æ•°é‡ç»Ÿè®¡**:
- æ–°å¢ Python æ–‡ä»¶: 4 ä¸ª
- æ–°å¢æ–‡æ¡£æ–‡ä»¶: 6 ä¸ª
- æ–°å¢è„šæœ¬æ–‡ä»¶: 2 ä¸ª
- æ€»è®¡: 12 ä¸ªæ–‡ä»¶

**ä»£ç é‡ç»Ÿè®¡**:
- æ ¸å¿ƒä»£ç : ~800 è¡Œ
- æ–‡æ¡£å’Œæ³¨é‡Š: ~2000 è¡Œ
- ç¤ºä¾‹ä»£ç : ~150 è¡Œ

**æ”¹åŠ¨èŒƒå›´**: 
- ä¿®æ”¹ç°æœ‰æ–‡ä»¶: 0 ä¸ª âœ…
- æ–°å¢æ–‡ä»¶: 12 ä¸ª
- åˆ é™¤æ–‡ä»¶: 0 ä¸ª

