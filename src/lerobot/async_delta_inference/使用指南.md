# Async Delta Inference ä½¿ç”¨æŒ‡å—

## ç®€ä»‹

`async_delta_inference` æ˜¯å¯¹ `async_inference` æ¡†æ¶çš„æ‰©å±•ï¼Œä½¿å…¶æ”¯æŒä»¿çœŸç¯å¢ƒï¼ˆå¦‚ Liberoï¼‰ã€‚é€šè¿‡æœ€å°åŒ–æ”¹åŠ¨åŸå§‹ä»£ç ï¼Œå®ç°äº†åœ¨ä»¿çœŸç¯å¢ƒä¸­ä½¿ç”¨å¼‚æ­¥æ¨ç†çš„åŠŸèƒ½ã€‚

## æ ¸å¿ƒç‰¹ç‚¹

- âœ… **å®Œå…¨å¤ç”¨** PolicyServerï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
- âœ… **æ”¯æŒ Libero** ä»¿çœŸç¯å¢ƒ
- âœ… **è‡ªåŠ¨è¯„ä¼°** å¤šä¸ª episode å¹¶ç»Ÿè®¡æˆåŠŸç‡
- âœ… **åŠ¨ä½œèšåˆ** æ”¯æŒå¤šç§ç­–ç•¥
- âœ… **æœ€å°æ”¹åŠ¨** ä¿æŒä¸åŸæ¡†æ¶ä¸€è‡´

## å¿«é€Ÿå¼€å§‹

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨å¿«é€Ÿå¯åŠ¨è„šæœ¬

**Linux/Mac:**
```bash
chmod +x examples/async_delta_inference/quick_start.sh
./examples/async_delta_inference/quick_start.sh
```

**Windows:**
```cmd
examples\async_delta_inference\quick_start.bat
```

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å¯åŠ¨

**æ­¥éª¤ 1: å¯åŠ¨ PolicyServer**ï¼ˆç»ˆç«¯ 1ï¼‰
```bash
python -m lerobot.async_inference.policy_server \
    --host=127.0.0.1 \
    --port=8080 \
    --fps=30
```

**æ­¥éª¤ 2: å¯åŠ¨ SimClient**ï¼ˆç»ˆç«¯ 2ï¼‰
```bash
python src/lerobot/async_delta_inference/sim_client.py \
    --env.type=libero \
    --env.task=libero_10 \
    --policy_type=act \
    --pretrained_name_or_path=lerobot/act_libero_10 \
    --policy_device=cuda \
    --actions_per_chunk=50 \
    --n_episodes=10
```

### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Python API

```python
from lerobot.async_delta_inference import SimClient, SimClientConfig
from lerobot.envs.configs import LiberoEnv
import threading

# é…ç½®
env_config = LiberoEnv(task="libero_10", fps=30)
config = SimClientConfig(
    env=env_config,
    policy_type="act",
    pretrained_name_or_path="lerobot/act_libero_10",
    policy_device="cuda",
    actions_per_chunk=50,
    n_episodes=10,
)

# è¿è¡Œ
client = SimClient(config)
client.start()

action_thread = threading.Thread(target=client.receive_actions, daemon=True)
action_thread.start()

client.control_loop(task="")
client.stop()
```

## ä¸»è¦å‚æ•°è¯´æ˜

### ç¯å¢ƒå‚æ•°
- `--env.type`: ç¯å¢ƒç±»å‹ï¼ˆ`libero`ï¼‰
- `--env.task`: ä»»åŠ¡å¥—ä»¶
  - `libero_10`: 10 ä¸ªé•¿æœŸä»»åŠ¡
  - `libero_90`: 90 ä¸ªé•¿æœŸä»»åŠ¡
  - `libero_spatial`: ç©ºé—´æ¨ç†
  - `libero_object`: ç‰©ä½“æ“ä½œ
  - `libero_goal`: ç›®æ ‡æ¡ä»¶

### ç­–ç•¥å‚æ•°
- `--policy_type`: ç­–ç•¥ç±»å‹ï¼ˆ`act`, `diffusion`, `smolvla` ç­‰ï¼‰
- `--pretrained_name_or_path`: æ¨¡å‹è·¯å¾„
- `--policy_device`: è®¾å¤‡ï¼ˆ`cuda`, `cpu`, `mps`ï¼‰
- `--actions_per_chunk`: æ¯æ¬¡æ¨ç†ç”Ÿæˆçš„åŠ¨ä½œæ•°é‡ï¼ˆé»˜è®¤ 50ï¼‰

### æ§åˆ¶å‚æ•°
- `--chunk_size_threshold`: å‘é€æ–°è§‚å¯Ÿçš„é˜ˆå€¼ï¼ˆ0.0-1.0ï¼Œé»˜è®¤ 0.5ï¼‰
  - è¶Šå° = è¶Šé¢‘ç¹æ¨ç†
  - è¶Šå¤§ = è¶Šä¾èµ–ç¼“å­˜åŠ¨ä½œ
- `--aggregate_fn_name`: åŠ¨ä½œèšåˆç­–ç•¥
  - `weighted_average`: åŠ æƒå¹³å‡ï¼ˆæ¨èï¼‰
  - `latest_only`: åªç”¨æœ€æ–°
  - `average`: ç®€å•å¹³å‡
  - `conservative`: ä¿å®ˆç­–ç•¥
- `--fps`: æ§åˆ¶é¢‘ç‡ï¼ˆé»˜è®¤ 30ï¼‰

### è¯„ä¼°å‚æ•°
- `--n_episodes`: è¯„ä¼°çš„ episode æ•°é‡ï¼ˆé»˜è®¤ 10ï¼‰

## è¾“å‡ºç¤ºä¾‹

```
[sim_client] Creating simulation environment: libero
[sim_client] Simulation environment ready
[sim_client] Connected to policy server in 0.0023s
[sim_client] Action receiving thread starting
[sim_client] Control loop thread starting
[sim_client] Episode 1/10 finished | Steps: 127 | Reward: 1.0000 | Success: True
[sim_client] Episode 2/10 finished | Steps: 134 | Reward: 1.0000 | Success: True
...
============================================================
Evaluation complete!
Episodes: 10
Average Reward: 0.9500
Success Rate: 95.00%
============================================================
```

## æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      gRPC      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SimClient         â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  PolicyServer       â”‚
â”‚                     â”‚                â”‚  (åŸæœ‰çš„ï¼Œæœªä¿®æ”¹)    â”‚
â”‚  - Libero ç¯å¢ƒ      â”‚  è§‚å¯Ÿ â”€â”€â”€â”€â”€â”€â–º  â”‚  - ç­–ç•¥æ¨¡å‹         â”‚
â”‚  - åŠ¨ä½œé˜Ÿåˆ—         â”‚                â”‚  - é¢„å¤„ç†å™¨         â”‚
â”‚  - è§‚å¯Ÿå‘é€å™¨       â”‚  â—„â”€â”€â”€â”€â”€â”€ åŠ¨ä½œ  â”‚  - åå¤„ç†å™¨         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¸¸è§é—®é¢˜

### 1. è¿æ¥å¤±è´¥
**ç°è±¡**: `Failed to connect to policy server`

**è§£å†³**:
- ç¡®è®¤ PolicyServer æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ç«¯å£ 8080 æ˜¯å¦è¢«å ç”¨
- ç¡®è®¤é˜²ç«å¢™å…è®¸æœ¬åœ°è¿æ¥

### 2. ç¯å¢ƒé”™è¯¯
**ç°è±¡**: æ‰¾ä¸åˆ° libero æ¨¡å—

**è§£å†³**:
```bash
pip install -e ".[libero]"
```

### 3. GPU å†…å­˜ä¸è¶³
**ç°è±¡**: CUDA out of memory

**è§£å†³**:
- ä½¿ç”¨è¾ƒå°çš„æ¨¡å‹
- å‡å°‘ `actions_per_chunk`
- ä½¿ç”¨ CPU: `--policy_device=cpu`

### 4. æ¨ç†é€Ÿåº¦æ…¢
**è§£å†³**:
- æ£€æŸ¥ GPU æ˜¯å¦è¢«æ­£ç¡®ä½¿ç”¨
- å¢åŠ  `chunk_size_threshold` å‡å°‘æ¨ç†é¢‘ç‡
- é™ä½ FPS è®¾ç½®

## è°ƒè¯•æŠ€å·§

### å¯ç”¨è¯¦ç»†æ—¥å¿—
åœ¨å¯åŠ¨æ—¶æ·»åŠ ç¯å¢ƒå˜é‡ï¼š
```bash
export LOG_LEVEL=DEBUG
python src/lerobot/async_delta_inference/sim_client.py ...
```

### å¯è§†åŒ–åŠ¨ä½œé˜Ÿåˆ—
```bash
python src/lerobot/async_delta_inference/sim_client.py \
    ... \
    --debug_visualize_queue_size=True
```

### æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨ `logs/` ç›®å½•ï¼š
- `logs/sim_client_*.log`: å®¢æˆ·ç«¯æ—¥å¿—
- `logs/policy_server_*.log`: æœåŠ¡å™¨æ—¥å¿—

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### é™ä½å»¶è¿Ÿ
1. ä½¿ç”¨æ›´å¿«çš„ GPU
2. å‡å°‘å›¾åƒåˆ†è¾¨ç‡ï¼ˆåœ¨ç¯å¢ƒé…ç½®ä¸­ï¼‰
3. å¢å¤§ `chunk_size_threshold`ï¼ˆä¾èµ–æ›´å¤šç¼“å­˜åŠ¨ä½œï¼‰

### æé«˜ç¨³å®šæ€§
1. ä½¿ç”¨ `weighted_average` èšåˆå‡½æ•°
2. é€‚å½“é™ä½ FPS
3. å¢åŠ  `actions_per_chunk`

### æ‰¹é‡è¯„ä¼°
```bash
# è¯„ä¼°æ›´å¤š episodes ä»¥è·å¾—å¯é çš„ç»Ÿè®¡
--n_episodes=50
```

## ä¸åŸæ¡†æ¶çš„å¯¹æ¯”

| ç‰¹æ€§ | async_inference | async_delta_inference |
|------|----------------|----------------------|
| ç¡¬ä»¶ | çœŸå®æœºå™¨äºº | ä»¿çœŸç¯å¢ƒ |
| PolicyServer | éœ€è¦ | å®Œå…¨å¤ç”¨ |
| è§‚å¯Ÿè·å– | robot.get_observation() | env.step() |
| åŠ¨ä½œæ‰§è¡Œ | robot.send_action() | env.step(action) |
| è¿è¡Œæ¨¡å¼ | æŒç»­è¿è¡Œ | å›ºå®š episodes |
| è¯„ä¼°æŒ‡æ ‡ | æ—  | è‡ªåŠ¨ç»Ÿè®¡ |

## æ‰©å±•æ”¯æŒ

ç›®å‰æ”¯æŒçš„ç¯å¢ƒï¼š
- âœ… Libero
- ğŸ”œ MetaWorldï¼ˆå³å°†æ”¯æŒï¼‰

è¦æ·»åŠ æ–°ç¯å¢ƒï¼Œå‚è€ƒ `constants.py` ä¸­çš„ `SUPPORTED_ENVS`ã€‚

## æ–‡ä»¶æ¸…å•

```
src/lerobot/async_delta_inference/
â”œâ”€â”€ __init__.py              # æ¨¡å—åˆå§‹åŒ–
â”œâ”€â”€ configs.py              # SimClientConfig
â”œâ”€â”€ constants.py            # å¸¸é‡
â”œâ”€â”€ sim_client.py           # æ ¸å¿ƒå®ç°
â”œâ”€â”€ README.md              # è‹±æ–‡æ–‡æ¡£
â””â”€â”€ ä½¿ç”¨æŒ‡å—.md             # ä¸­æ–‡æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰

examples/async_delta_inference/
â”œâ”€â”€ evaluate_libero.py      # Python API ç¤ºä¾‹
â”œâ”€â”€ quick_start.sh          # Linux/Mac å¯åŠ¨è„šæœ¬
â”œâ”€â”€ quick_start.bat         # Windows å¯åŠ¨è„šæœ¬
â””â”€â”€ README.md              # ç¤ºä¾‹è¯´æ˜
```

## è´¡çŒ®ä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼š
1. æ£€æŸ¥æœ¬æ–‡æ¡£å’Œ README.md
2. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æ’æŸ¥é—®é¢˜
3. åœ¨ GitHub æäº¤ issue

---

**æç¤º**: ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼Œæ¨¡å‹ä¸‹è½½å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸ã€‚

